var Polygon={path_color:"#047cf8",path_background_color:"rgba(4, 124, 248, 0.4)",center_image:"/webroot/img/plugins/polygons/dot.png",center_image_size:20,center_image_timeout:30000,show_dots_timeout:100,shound_hide_dots:true,images:{},isApp:(new URLSearchParams(window.location.search)).get('client')=='app',main:function(){this.should_hide_dots=!this.isMobile();if(!Polygon.isApp)this.globalListeners();this.checkPathsAndDraw();$("#polygonTooltipMobile").hide();},addImage:function(id_image,paths){if(paths==undefined){return;}this.images[id_image]={'id_image':id_image,paths:paths};},checkPathsAndDraw:function(){if(Polygon.images==undefined||Object.keys(Polygon.images).length==0){return;}$.ajax({async:true,type:"POST",dataType:"json",contentType:'application/json',data:JSON.stringify({action:'check_polygons',image_paths:Polygon.images}),url:validateURL.URL()+'/api/polygon/',success:function(result){if(result.success){Polygon.images=result.data.image_paths;Polygon.drawAll();}}});},drawAll:function(){$.each(Polygon.images,function(id_image,image){Polygon.drawSvg(id_image);});},drawSvg:function(id_image){var self=this;if(self.images[id_image].canvas!=undefined){self.images[id_image].canvas.remove();}var image=$("img[data-i-id='"+id_image+"']");var x1=image.width();var y1=image.height();var paths=self.images[id_image].paths.polygon_paths;if(paths==undefined||paths.length==0){return;}self.images[id_image].canvas=Raphael("img_container_"+id_image,'100%','100%');self.images[id_image].svg_element=$(self.images[id_image].canvas);self.images[id_image].canvas.setViewBox(0,0,x1,y1)
$.each(paths,function(key,path){var recPath=self.recalculateCoordinates(path,x1);var drawing_path=null;var drawing_center=null;switch(path.figure_type){case"rectangle":var coords=recPath.coordinates.split(" ");var width=Math.abs(coords[0]-coords[2]);var height=Math.abs(coords[1]-coords[3]);drawing_path=self.images[id_image].canvas.rect(coords[0],coords[1],width,height);break;default:drawing_path=self.images[id_image].canvas.path();drawing_path.attr({path:recPath.coordinates});break;}drawing_path.attr({stroke:Polygon.path_color,"stroke-width":1,fill:Polygon.path_background_color,opacity:0});$(drawing_path.node).attr("data-function_type",path.function_type);if(Polygon.isMobile()&&path.center_x!==undefined&&path.center_y!==undefined&&path.spot_in_devices){var center_x=Polygon.recalculateSize(path.center_x,path.edition_width,x1)-(Polygon.center_image_size/2);var center_y=Polygon.recalculateSize(path.center_y,path.edition_width,x1)-(Polygon.center_image_size/2);drawing_center=self.images[id_image].canvas.image(self.center_image,center_x,center_y,self.center_image_size,self.center_image_size);drawing_center.click(function(e){Polygon.pathClicked(path,id_image,e)});var hideImage=function(e){setTimeout(function(e){if(self.should_hide_dots){$(drawing_center.node).css("opacity",0);}},self.center_image_timeout);};drawing_center.hover(function(e){$(e.target).css("opacity",1);Polygon.pathHover(path,id_image,e);},function(e){$(e.target).css("opacity",0.9);hideImage();});if(true){hideImage();}}drawing_path.click(function(e){Polygon.pathClicked(path,id_image,e)});drawing_path.hover(function(e){Polygon.pathHover(path,id_image,e)});});},showImagesDots:function(){$.each(Polygon.images,function(id_image,image_obj){if(Polygon.isOnScreen($("img[data-i-id='"+id_image+"']"))&&!Polygon.isMobile()){setTimeout(function(){$("img[data-i-id='"+id_image+"']").siblings("svg").find("image").css("opacity",0.8);},Polygon.show_dots_timeout);}else{setTimeout(function(){$("img[data-i-id='"+id_image+"']").siblings("svg").find("image").css("opacity",0);},100);}});},recalculateCoordinates:function(path,new_width){var newPath=JSON.parse(JSON.stringify(path));var coordinates=[];$.each(path.coordinates.split(" "),function(key,value){var val=Polygon.recalculateSize(value,path.edition_width,new_width);coordinates.push(val);});newPath.coordinates=coordinates.join(" ");return newPath;},recalculateSize:function(value,old_width,new_width){var val=value;if($.isNumeric(value)){var percentSize=new_width/old_width;val=Math.floor(value*percentSize);}return val;},pathClicked:function(path,id_image,event,forceOpen){event.preventDefault();event.stopPropagation();if(!Polygon.isMobile()||forceOpen===true){switch(path.function_type){case"open_url":Polygon.openNewTab(event,path.function_value);break;case"item":case"product":if(Polygon.isApp){$('#polygonTooltipMobile').hide();Polygon.openProduct(path.function_value);}else{Polygon.openProductModal(event,path.function_value);}break;}}else{Polygon.openMobileTooltip(path,id_image,event);}},openMobileTooltip:function(path,id_image,event){var callback=function(content){$("#polygonTooltipMobile .polygonTooltipContent").html(content);$("#polygonTooltipMobile").show();$("#polygonTooltipMobile").off("click").on("click",function(e){e.preventDefault();$(this).removeClass("show");setTimeout(function(){$(this).hide();},500);if(Polygon.isApp&&$(e.target).hasClass('polygonTooltipClose')){$('#polygonTooltipMobile').hide();}else{Polygon.pathClicked(path,id_image,event,true);}}).addClass("show");};Polygon.getTooltipContent(path,id_image,event,callback);},pathHover:function(path,id_image,event){event.preventDefault();if(Polygon.isMobile()){return;}var element=$(event.target);Polygon.getTooltipContent(path,id_image,element,function(content){Polygon.setPathTooltip(element,id_image,content);});},openNewTab:function(event,url){var win=window.open(url,'_blank');win.focus();},openProductModal:function(event,id_item){sidenavLoadItem(event,$("<div data-item='"+id_item+"'></div>"));},openProduct:function(id_item){window.location.href='/products/'+id_item;},getTooltipContent:function(path,id_image,element,callback){var tooltip_content=Polygon.images[id_image].tooltip_content;if(tooltip_content!==undefined&&tooltip_content[path.function_type]!==undefined&&tooltip_content[path.function_type][path.function_value]!==undefined){callback(tooltip_content[path.function_type][path.function_value]);}else{Polygon.last_tooltip_key=[id_image,path.function_type,path.function_value].join('_');$.ajax({async:true,type:"POST",dataType:"json",contentType:'application/json',data:JSON.stringify({action:'tooltip_content',path:path}),url:validateURL.URL()+'/api/polygon/',success:function(result){if(result.success){Polygon.setPathTooltipResponse(path,id_image,element,result.tooltip);if(Polygon.last_tooltip_key==[id_image,path.function_type,path.function_value].join('_')){callback(result.tooltip);}}}});}},setPathTooltipResponse:function(path,id_image,element,content){if(Polygon.images[id_image].tooltip_content===undefined){Polygon.images[id_image].tooltip_content={};}if(Polygon.images[id_image].tooltip_content[path.function_type]===undefined){Polygon.images[id_image].tooltip_content[path.function_type]={};}Polygon.images[id_image].tooltip_content[path.function_type][path.function_value]=content;},setPathTooltip:function(element,id_image,content){var width=300;switch(element.data("function_type")){case"product":width=300;break;case"open_url":break;}element.tooltip({template:'<div class="tooltip polygon-tooltip" role="tooltip"><div class="arrow"></div><div class="tooltip-inner"></div></div>',container:"body",title:content,trigger:'hover',html:true,placement:'auto'});element.tooltip('show');setTimeout(function(){if(!element.is(":hover")){element.tooltip('hide');}},1000);element.off('mousemove').on('mousemove',function(e){var tooltip=$("#"+$(this).attr("aria-describedby"));var top=e.pageY+10;var left=e.pageX+10;var contentWidth=$(window).innerWidth()-30;if(left+tooltip.width()>contentWidth){left=contentWidth-tooltip.width();}if(width!="auto"){width=width+"px";}tooltip.css({left:left,top:top,transform:"translate3d(0px, 0px, 0px)",width:width});});},isMobile:function(){return $(window).width()<992||Polygon.isApp;},isOnScreen:function(elem){if(elem.length===0){return false;}var $window=$(window);var viewport_top=$window.scrollTop();var viewport_height=$window.height();var viewport_bottom=viewport_top+viewport_height;var $elem=$(elem);var top=$elem.offset().top;var height=$elem.height();var bottom=top+height;return(top>=viewport_top&&top<viewport_bottom)||(bottom>viewport_top&&bottom<=viewport_bottom)||(height>viewport_height&&top<=viewport_top&&bottom>=viewport_bottom)},globalListeners:function(){var scrollTimeout;window.addEventListener('scroll',function(e){clearTimeout(scrollTimeout);scrollTimeout=setTimeout(Polygon.showImagesDots,500);});$(".polygonTooltipClose").click(function(e){e.preventDefault();e.stopPropagation();$("#polygonTooltipMobile").removeClass("show");setTimeout(function(){$("#polygonTooltipMobile").hide();},500);});}};$(document).ready(function(){Polygon.main();});